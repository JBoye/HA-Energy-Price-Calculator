nordpool_calculator:
  template:
    - sensor:
        - name: "Price Calculator"
          attributes:
            start_times: >
              {# Configuration #}

              {# Name of Nordpool Sensor #}
              {% set sensor_name = "sensor.elpris" %}

              {# Consumption in kW #}
              {% set consumption = 230 * 16 / 1000 %}

              {# Duration of charging, washing, etc.  #}
              {% set duration = timedelta(hours = 10 / consumption, minutes = 0) %} 

              {# First possible time to start. Default now() #}
              {% set start_time = today_at("00:00") + timedelta(hours = 0) %} 

              {# Deadline for when the operation should be finished (For example departure time). 
              Default tomorrow at 23:59:59 if tomorrows prices are available, otherwise today at 23:59:59 #}
              {% set end_time = today_at("00:00") + timedelta(hours = 12) %} 

              {# Helpers #}
              {%- macro date_to_index(date) -%}{{(date.hour + (date.date() - now().date()).days * 24)}}{%- endmacro -%}{# as datetime? #}
              {%- macro index_to_date(index) -%}{{today_at("00:00") + timedelta(hours = index)}}{%- endmacro -%}{# as int? #}
              {% set start_hour = date_to_index(start_time) | int %}
              {% set end_hour = 1 + date_to_index(end_time - duration) | int %}
              {% set prices_raw = state_attr(sensor_name, "raw_today") + state_attr(sensor_name, "raw_tomorrow") %}

              {# End time can not be later than the available price data #}
              {% set end_time = [end_time, (prices_raw | last).end] | min %}
              {% set prices = prices_raw[start_hour:end_hour] %}

              {# namespace to hold values #}
              {% set ns = namespace(start_times = []) %}
              {% for price in prices %}
                {% set item = namespace(start = price.start, end = price.start + duration) %}
                {% if loop.first %}
                  {% set item.start = start_time %}
                  {% set item.end = start_time + duration %}
                {% elif loop.last %}
                  {% set item.start = end_time - duration %}
                  {% set item.end = end_time %}
                {% endif %}
                {% set item.value = 0%}
                {% for index in range(date_to_index(item.start) | int, date_to_index(item.end) | int + 1) %}
                    {% set hour_duration = ([item.end, index_to_date(index + 1) | as_datetime] | min - [item.start, index_to_date(index) | as_datetime] | max).total_seconds() / 60 / 60 %}
                    {% if hour_duration > 0 %}
                      {% set item.value = item.value + (prices_raw[index].value * hour_duration) %}
                    {% endif %}                    
                {% endfor %}
                {% set ns.start_times = ns.start_times + [{'start': item.start | string, 'end': item.end | string, 'value': item.value * consumption}] %}
              {% endfor -%}
              {{ns.start_times | tojson}}

          state: >
            Calculating...

        - name: "Price Calculator Price now"
          state: >
            {{ state_attr("sensor.price_calculator", "start_times")[0].value | round (2)}}

        - name: "Price Calculator Cheapest Time"
          state: >
            {{ (state_attr("sensor.price_calculator", "start_times") | sort(attribute='value'))[0].start }}

        - name: "Price Calculator Cheapest Price"
          state: >
            {{ (state_attr("sensor.price_calculator", "start_times") | sort(attribute='value'))[0].value | round (2)}}

    - binary_sensor:
        - name: "Price Calculator Is cheapest"
          state: >
            {{ (state_attr("sensor.price_calculator", "start_times") | sort(attribute='value'))[0] == state_attr("sensor.price_calculator", "start_times")}}
